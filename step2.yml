- hosts: webservers
  vars: 
    - venv_home: /home/vagrant/.virtualenvs/libreborme
    - www_dir: /var/www
    - lb_home: /home/vagrant/libreborme/
    - libreborme_dir: "{{ www_dir }}/libreborme"
    - project_name: mylibreborme
  become: True

  tasks:

  - name: create project folder
    file: dest={{ libreborme_dir }} state=directory owner=vagrant group=www-data mode=0775

  - name: create project {{ project_name }}
    shell:
      . {{ venv_home }}/bin/activate && cd {{ www_dir }} && libreborme startproject {{ project_name }} libreborme creates={{ libreborme_dir }}/manage.py

  - name: set permissions to project folder
    file: dest={{ libreborme_dir }} state=directory owner=vagrant group=www-data recurse=yes

  - name: set permissions to folders
    file: dest={{ libreborme_dir }}/{{item}} mode=0775
    with_items:
      - log
      - "{{ project_name }}/media"

  - name: set permissions to manage.py
    file: dest={{ libreborme_dir }}/manage.py mode=0750

  - name: Configuring piwik I
    lineinfile: dest={{ libreborme_dir }}/{{ project_name }}/settings.py regexp="^PIWIK_URL" line="PIWIK_URL = 'piwik.libreborme.net/'"

  - name: Configuring piwik II
    lineinfile: dest={{ libreborme_dir }}/{{ project_name }}/settings.py regexp="^PIWIK_SITE_ID" line="PIWIK_SITE_ID = '1'"

  - name: Enabling DEBUG mode
    lineinfile: dest={{ libreborme_dir }}/{{ project_name }}/settings.py regexp="^DEBUG" line="DEBUG = True"

  - name: Configuring Django INTERNAL_IPS
    lineinfile: dest={{ libreborme_dir }}/{{ project_name }}/settings.py regexp="^INTERNAL_IPS" line="INTERNAL_IPS = ('192.168.33.1',)"

  - name: Create database
    postgresql_db: name=libreborme
    become_user: postgres

  - name: Create username for database libreborme
    postgresql_user: db=libreborme name=libreborme password=password priv=ALL
    become_user: postgres

  - name: Configure hstore extension in postgresql
    postgresql_ext: name=hstore db=libreborme
    become_user: postgres

  - name: Allow connections to database from 192.168.33.1/24
    lineinfile: 
      dest=/etc/postgresql/9.4/main/pg_hba.conf
      regexp="^host\s+all\s+all\s+192.168.33.1"
      line="host    all             all             192.168.33.1/24         trust"
    notify: restart postgresql

  - name: Running django migrate
    django_manage: command="migrate --no-initial-data" virtualenv={{ venv_home }} app_path={{ libreborme_dir }}

  - name: Running django collectstatic
    django_manage: command="collectstatic --noinput" virtualenv={{ venv_home }} app_path={{ libreborme_dir }}

  - name: Update libreborme version data
    django_manage: command="updateversion" virtualenv={{ venv_home }} app_path={{ libreborme_dir }}

  - name: Configuring bashrc I
    lineinfile: dest=/home/vagrant/.bashrc line=". ~/.virtualenvs/libreborme/bin/activate"

  - name: Configuring bashrc II
    lineinfile: dest=/home/vagrant/.bashrc line="cd {{ libreborme_dir }}"

  handlers:
    - name: restart postgresql
      service: name=postgresql state=restarted
